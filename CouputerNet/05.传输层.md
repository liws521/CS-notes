# 传输层

## 传输层概述
- 传输层为应用进程提供端到端的逻辑通信
- 传输层协议要提供端到端的错误恢复与流量控制, 对网络层出现的丢包, 乱序或重复等问题做出反应
- 传输层使用协议端口号(简称端口)来判断进程通信, 端口号为16位的二进制数, 即位于0~65535之间的整数
- 端口号分类
    - 服务器端使用的端口号, 包括专用端口号, 也称为熟知端口号, 绑定于一些特定的服务, 比如FTP-20/21, DNS-53等, 还包括注册端口号1024~49151
    - 客户端口, 49152~65535, 仅在客户进程运行时才动态分配, 通信结束后被收回
- 常用的端口号及对应协议
    - https://www.bilibili.com/video/BV1Mb4y1k7ng?p=14
- 端口号拼接到IP地址就构成了套接字
    - 套接字 socket = (IP地址 : 端口号)
- TCP/IP的传输层有两个不同的协议
    - 用户数据报协议(User Datagram Protocol), 无连接且不可靠
    - 传输控制协议(Transmission Control Protocol), 面向连接的, 可靠的

## 用户数据报协议UDP
- UDP分组称为用户数据报, 有8个字节的固定首部, 由4个字段组成, 每个字段2字节
- https://www.bilibili.com/video/BV1Mb4y1k7ng?p=14 12分钟
- UDP使用套接字地址提供进程到进程的通信, 也就是端到端的通信
- 无连接服务, 数据报独立, 没有编号, 不排序, 数据报可以沿不同路径传递
- 没有流量控制, 没有窗口机制, 当到来的报文太多时接收方可能会溢出
- 除了校验和外, UDP没有差错控制机制, 发送方不知道报文丢失还是重传
- 不提供拥塞控制, UDP假设发送的分组很小且零星, 不会在网络中造成拥塞
- 封装和解封装
- 多路复用和多路分解

## 传输控制协议TCP
- 面向连接的传输, 端到端的通信, 高可靠服务
- 全双工通信
- 采用字节流方式, 即以字节为单位传输字节序列
- 可靠的连接建立

### TCP报文格式
- TCP传输的数据单元式报文, 也称报文段, 一个TCP报文段由首部和数据段两部分组成
- 首部是TCP为了实现端到端可靠传输所加上的控制信息, 而数据段部分则是由高层也就是应用层传来的数据
- TCP格式图 https://www.bilibili.com/video/BV1P44y1z7Tv?p=14 16分
![](images\tcp.jpg)
- 序号seq, 确认号ack
- SYN发起一个新的连接, ACK为1时确认号才有效, FIN结束一个连接

### TCP连接管理
- 三次握手建立连接, 四次握手释放连接(每一个来回断开一条路)
- https://www.cnblogs.com/jainszhang/p/10641728.html
- https://www.bilibili.com/video/BV1P44y1z7Tv?p=14 23分
- TIME_WAIT状态(interview)
    - https://zhuanlan.zhihu.com/p/99943313 这个讲的非常清楚
    - 主动关闭方在收到被动关闭方的FIN包后并返回ACK后, 会进入TIME_WAIT状态, 每个TCP连接都必须有一个最大报文段生存时间MSL, 在网络传输中超过这个时间的报文将被丢弃.
- CLOSE-WAIT状态(interview)
- TCP流量控制和拥塞控制
     - TCP采用可变发送窗口机制来实现流量控制